---
title: mysql的回表
type: categories
copyright: true
date: 2022-03-12 23:47:11
tags:
    - 数据库
    - mysql
categories: [数据库, mysql]
keywords: mysql回表
---

<script type="text/javascript" src="/js/src/bai.js"></script>

## mysql回表查询的简单介绍

InnoDB为引擎的mysql数据库有两大类索引，一类为聚集索引，另一类为普通索引；
- 聚集索引

&emsp;&emsp; 聚集索引的叶子节点存储行记录，因此innoDB必须要有且只能有一个聚集索引；

&emsp;&emsp; 如果表定义了主键，那么主键就是聚集索引；

&emsp;&emsp; 如果表没有定义主键，那么第一个非空唯一的列就是聚集索引；

&emsp;&emsp; 如果既没有定义主键，也没有非空唯一的列，那么innoDB会创建一个隐藏的rowid作为聚集索引；

<!-- more -->
- 普通索引

&emsp;&emsp; 普通索引的叶子节点存储的是主键值(MyISAM引擎则是存储的行记录头指针)；

### 回表查询

简单来说，回表查询就是当我们通过普通索引去查询行记录的时候，先通过扫描普通索引的B+索引树，找到行记录的主键值，然后根据主键值扫描聚集索引的B+索引树定位到要查找的行记录；

这个过程中，我们扫描了两遍索引树，第一遍先定位行记录的主键，第二遍根据主键定位到行记录，整个过程就是回表查询；回表查询相对于主键查询多了一次扫描索引树的过程，性能要低一些；

### 索引覆盖

索引覆盖是一种避免回表查询的优化策略，简单来说就是将我们要查询的数据建立普通索引，可以是单列索引，也可以是和其他字段一起的联合索引；这样我们查询的数据就是索引值，可以直接返回结果；

当我们需要查询的数据列本身就是索引时，我们应当避免进行
```
select * from table where ...
```
的查询，这会回表查询整个行记录；

要注意的是，不是所有类型的索引都可以成为覆盖索引的。因为覆盖索引必须要存储索引的列值，而哈希索引、空间索引和全文索引等都不存储索引列值，索引MySQL只能使用B-Tree索引做覆盖索引。

另外，当发起一个被索引覆盖的查询(索引覆盖查询)时，在explain(执行计划)的Extra列可以看到【Using Index】的信息。

## mysql的脏读，幻读和不可重复读

### 脏读
读取到了没有提交的数据（如果事物回滚了，那么第二个事物就读到了脏数据）
可能的原因：
- 有一个交叉的事物有一个新的提交commit，导致了数据的改变；
- 一个数据库被多个实例操作时，同一事物的其他实例在该实例操作期间进行了新的提交commit；

### 幻读
幻读是指当用户进行范围查询时，另一个事物在该范围内进行了插入或删除的操作，当用户再次查询时会发现多了或者少了行记录；

InnoDB通过多版本并发控制(MVCC)机制解决了该问题；

### 不可重复读
不可重复读是指在同一个事物中，对同一数据执行完全相同的查询语句得到的结果不一样；


### mysql事物隔离级别
- 未提交读

&emsp;&emsp; 会出现脏读，幻读，不可重复读；

- 已提交读

&emsp;&emsp; 会出现幻读，不可重复读，不会出现脏读；

- 可重复读

&emsp;&emsp; 不会脏读，幻读，InnoDB不会出现不可重复读；

- 串行化

&emsp;&emsp; 不会脏读，幻读，不可重复读；

